import Image from "next/image";

# Concepts de base

Cette section explique comment les éléments clés d’O3 s’articulent. À la fin, vous devriez comprendre comment O3 démarre
et comment les modules sont chargés et configurés. Le schéma ci-dessous montre les principaux blocs et leurs liens.

<div className="my-6">
  <Image
    src="/o3-architecture.svg"
    alt="Architecture d’O3"
    width={800}
    height={800}
    sizes="(max-width: 768px) 100vw, 800px"
  />
</div>

**Notes sur le schéma (pour la clarté) :** le « distribution manifest » correspond au fichier
`spa-assemble-config.json`, qui génère la carte d’importation. Les modules se chargent à l’exécution depuis les URLs de
la carte (souvent un CDN ou un serveur de dev local), et non directement depuis npm. « Webpack dev server (proxy) »
représente le proxy de développement local ; beaucoup de packages utilisent désormais Rspack, mais le principe reste le
même.

Les principaux éléments de l'architecture frontale d'O3 sont les suivants:

- Le [shell de l'application](/docs/core-concepts#app-shell) - la couche de base qui coordonne le démarrage et l’exécution.
- Les [modules frontaux](/docs/core-concepts#frontend-modules) - blocs UI composables.
- La [carte d'importation](/docs/core-concepts#import-map) - un fichier JSON qui indique quels modules charger et où les récupérer.
- Le [core framework](/docs/core-concepts#core-framework) - bibliothèques et API partagées par les modules frontaux.

## Où cela se trouve dans le code

Si vous voulez voir ces éléments dans l’implémentation de référence, le monorepo
[`openmrs-esm-core`](https://github.com/openmrs/openmrs-esm-core) les regroupe ainsi :

- **App shell** : [`packages/shell/esm-app-shell`](https://github.com/openmrs/openmrs-esm-core/tree/main/packages/shell/esm-app-shell)
- **Core framework** (agrégé) : [`packages/framework/esm-framework`](https://github.com/openmrs/openmrs-esm-core/tree/main/packages/framework/esm-framework)
- **Librairies du framework** (packages individuels) : [`packages/framework/*`](https://github.com/openmrs/openmrs-esm-core/tree/main/packages/framework)
- **Modules frontend de base** : [`packages/apps/*`](https://github.com/openmrs/openmrs-esm-core/tree/main/packages/apps)

## Shell de l'application

L’app shell est l’application hôte qui démarre O3 et coordonne le chargement et les services d’exécution. Introduit dans
[RFC-26](https://github.com/openmrs/openmrs-rfc-frontend/blob/e745ee9c37b2ca0ae6f4fc93259724e61bfac82e/text/0026-activation-distribution.md),
il gère :

- **Démarrage :** prépare `index.html`, charge la carte d’importation et connecte routes/activateurs.
- **Services d’exécution :** définit points d’arrêt, abonnements (modales, toasts, notifications) et le mode hors ligne.
- **Couplage plateforme :** initialise l’état global et met en place configuration et extensions.

Pour aller plus loin : [Approfondir la coque d'application](/docs/app-shell)

### Modules frontaux

Les [modules frontaux](/docs/frontend-modules/overview) sont les unités de fonctionnalité qui composent l’UI d’O3.
Pensez à chaque module comme une mini‑application qui gère une partie de l’interface (par exemple, le dossier patient
ou la navigation principale).

O3 traite ces modules comme des `microfrontends` (terme popularisé par [single-spa](https://single-spa.js.org)).
L’app shell charge les modules via la carte d’importation et appelle l’**activation** (point d’entrée) de chaque module
pour enregistrer les routes et les extensions. Les modules exportent des fonctions de cycle de vie conformes à
l’interface définie dans [RFC-26](https://github.com/openmrs/openmrs-rfc-frontend/blob/e745ee9c37b2ca0ae6f4fc93259724e61bfac82e/text/0026-activation-distribution.md).
Dans la plupart des distributions, cette carte d’importation est générée à partir de `spa-assemble-config.json`.
Les extensions sont des blocs UI plug‑in que les modules enregistrent dans des emplacements nommés.

Notions essentielles (les fichiers que vous manipulerez le plus souvent) :

- `package.json` - métadonnées, scripts et dépendances du module
- `src/index.ts` - point d’entrée qui enregistre routes et extensions
- `routes.json` - métadonnées statiques pour l’app shell
- `config-schema.ts` - où se trouvent les propriétés de configuration du module

Les modules frontaux sont chargés à la demande par l’app shell lorsqu’ils sont nécessaires, ce qui améliore le temps de
chargement initial.

Les modules frontaux peuvent vivre dans des dépôts autonomes ou dans des monorepos orientés domaine lorsque plusieurs
modules partagent un même périmètre. Par exemple, les modules de gestion des patients (inscription, files d’attente,
rendez-vous, gestion des lits, etc.) sont regroupés dans le monorepo
[`openmrs-esm-patient-management`](https://github.com/openmrs/openmrs-esm-patient-management).

Vous choisissez quels modules inclure dans une distribution en modifiant son fichier `spa-assemble-config.json`. Pour
ajouter un module personnalisé, partez du dépôt [template app](https://github.com/openmrs/openmrs-esm-template-app),
publiez-le sur npm sous votre propre espace de noms, puis ajoutez une entrée pour ce module dans
`spa-assemble-config.json`.

Ensuite :

- [Aperçu des modules frontend](/docs/frontend-modules/overview)
- [Anatomie d’un module frontend](/docs/frontend-modules/overview#anatomy-of-a-frontend-module)
- [Tags de version (`next` vs `latest`)](/docs/frontend-modules/overview)

## Carte d'importation

Une carte d'importation est une spécification du navigateur qui mappe des noms de modules vers leurs URLs de chargement.
Introduite dans [RFC-4](https://github.com/openmrs/openmrs-rfc-frontend/blob/master/text/0004-import-maps.md), elle indique
au shell où récupérer chaque module. L’app shell précharge la carte au démarrage puis l’utilise pour résoudre et charger
les bundles.

En pratique, les cartes d’importation sont générées et servies par la distribution (pas par l’app shell). Par exemple,
la carte d'importation [de l'application de référence de la communauté O3](https://dev3.openmrs.org/openmrs/spa) est
servie à `/openmrs/spa/importmap.json`, et sa source se trouve dans
[le référentiel de configuration d'OpenMRS](https://github.com/openmrs/openmrs-distro-referenceapplication/blob/212eb93547e9946621e749c98b3eb2a0048252f0/frontend/spa-build-config.json#L4).
La plupart des distributions suivent la même approche.

Pour voir la carte d'importation de votre distro dans le navigateur, naviguez vers `/openmrs/spa/importmap.json` (ou le
chemin de base SPA de votre distro), où vous verrez quelque chose comme:

```json
{
  "imports": {
    "@openmrs/esm-home-app": "./openmrs-esm-home-app-4.1.1-pre.211/openmrs-esm-home-app.js",
    "@openmrs/esm-login-app": "./openmrs-esm-login-app-4.3.2-pre.671/openmrs-esm-login-app.js",
    "@openmrs/esm-primary-navigation-app": "./openmrs-esm-primary-navigation-app-4.3.2-pre.671/openmrs-esm-primary-navigation-app.js",
    "@openmrs/esm-patient-chart-app": "./openmrs-esm-patient-chart-app-4.3.1-pre.1352/openmrs-esm-patient-chart-app.js"
    // ... d’autres modules
  }
}
```

Les clés de cet objet sont les noms des modules (identifiants uniques) et les valeurs sont des chemins relatifs vers les
modules frontaux. Le shell lit cette carte à l’exécution et enregistre chaque module dans le navigateur. La plupart des
modules sont des bundles de fédération de modules, et certains modules historiques sont chargés comme scripts SystemJS.
Voir la page [Approfondir la coque d'application](/docs/app-shell) pour les détails du chargement.

Pour aller plus loin : [Système de configuration](/docs/configuration-system)

## Comment O3 charge les modules (modèle mental rapide)

1. L’app shell démarre et précharge la carte d’importation.
2. Il résout les URLs des modules et enregistre les bundles dans le navigateur.
3. Il appelle l’activateur de chaque module pour enregistrer routes et extensions.
4. Le routeur monte les modules au fil de la navigation.

## Si vous devez changer…

- **Quels modules chargent (et leurs versions)** → modifiez `spa-assemble-config.json` (source de la carte d’importation).
- **Comment les modules se chargent globalement** → configuration/comportement de l’app shell.
- **Ce que fait un module** → dépôt du module (UI, routes, extensions, config).

## Cadre de base

Le framework O3 est packagé comme une bibliothèque JavaScript dans le [registre NPM](https://www.npmjs.com/package/@openmrs/esm-framework). La plupart du code applicatif importe `@openmrs/esm-framework` pour utiliser ces services :

- **Services plateforme :** configuration, routes, état, extensions et indicateurs de fonctionnalité.
- **Navigation et UX :** navigation, fil d’Ariane et mode hors ligne.
- **Utilitaires développeur :** helpers API, globals et utilitaires généraux.

Pour aller plus loin : [Référence de l'API du framework](/docs/framework-api-reference)

## Prochaines étapes

Prêt à construire ? Continuez avec [Modules frontend](/docs/frontend-modules/overview) pour voir comment les modules sont
structurés et chargés.
