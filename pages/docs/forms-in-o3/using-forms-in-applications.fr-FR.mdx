import { Callout, Steps } from "nextra-theme-docs";

# Utiliser les formulaires dans les applications

Une fois que vous avez cr√©√© un formulaire √† l'aide du [Form Builder](/docs/forms-in-o3/build-forms-with-o3-form-builder) ou converti un formulaire HTML Form Entry existant, vous devrez l'int√©grer dans votre application. Le React Form Engine offre des moyens flexibles de rendre les formulaires dans diff√©rents contextes, des espaces de travail du dossier patient aux applications personnalis√©es.

## Vue d'ensemble

Le React Form Engine peut √™tre utilis√© de deux mani√®res principales :

1. **Extension Form Renderer** - Un composant pr√©-construit qui g√®re le chargement des formulaires, le rendu et l'int√©gration dans les espaces de travail. C'est le moyen le plus simple de rendre les formulaires dans les espaces de travail.
2. **Composant FormEngine** - Le composant principal qui offre un contr√¥le total sur le rendu des formulaires, la soumission et le comportement.

## Rendre les formulaires dans les espaces de travail

Le moyen le plus simple de rendre un formulaire dans un espace de travail est d'utiliser l'extension `react-form-engine-widget` fournie par `@openmrs/esm-form-engine-app`. Cette extension g√®re automatiquement le chargement des formulaires, les √©tats d'erreur et l'int√©gration dans les espaces de travail.

### √âtape 1 : Enregistrer l'espace de travail du formulaire

Dans le fichier `routes.json` de votre module, enregistrez un espace de travail :

```json
{
  "workspaces": [
    {
      "name": "my-form-workspace",
      "title": "Mon formulaire",
      "component": "myFormWorkspace",
      "type": "clinical-form",
      "canMaximize": true,
      "width": "wider"
    }
  ]
}
```

<Callout emoji="‚ÑπÔ∏è" type="info">
L'extension `react-form-engine-widget` est d√©j√† enregistr√©e par `@openmrs/esm-form-engine-app` dans le slot `form-widget-slot`. Vous n'avez pas besoin de l'enregistrer √† nouveau sauf si vous cr√©ez un renderer de formulaire personnalis√©.
</Callout>

### √âtape 2 : Cr√©er le composant de l'espace de travail

Cr√©ez un composant d'espace de travail qui utilise `ExtensionSlot` pour rendre le formulaire :

```tsx
import React from 'react';
import { ExtensionSlot } from '@openmrs/esm-framework';
import { type DefaultPatientWorkspaceProps } from '@openmrs/esm-patient-common-lib';

interface MyFormWorkspaceProps extends DefaultPatientWorkspaceProps {
  formUuid: string;
  encounterUuid?: string;
}

export function MyFormWorkspace({ 
  patientUuid, 
  formUuid, 
  encounterUuid,
  closeWorkspace,
  promptBeforeClosing,
  closeWorkspaceWithSavedChanges 
}: MyFormWorkspaceProps) {
  const state = {
    view: 'form',
    formUuid,
    patientUuid,
    encounterUuid: encounterUuid ?? null,
    closeWorkspace,
    promptBeforeClosing,
    closeWorkspaceWithSavedChanges,
  };

  return (
    <ExtensionSlot name="form-widget-slot" state={state} />
  );
}
```

### √âtape 3 : Lancer l'espace de travail

Lancez l'espace de travail avec l'UUID du formulaire :

```tsx
import { launchWorkspace } from '@openmrs/esm-framework';

function launchMyForm(patientUuid: string, formUuid: string) {
  launchWorkspace('my-form-workspace', {
    patientUuid,
    formUuid,
    workspaceTitle: 'Mon formulaire'
  });
}
```

<Callout emoji="üí°" type="info">
L'extension form renderer g√®re automatiquement le chargement du sch√©ma de formulaire, les √©tats d'erreur et la gestion du cycle de vie de l'espace de travail. C'est l'approche recommand√©e pour la plupart des cas d'usage.
</Callout>

## Utiliser FormEngine directement

Pour plus de contr√¥le sur le rendu et le comportement des formulaires, vous pouvez utiliser le composant `FormEngine` directement depuis `@openmrs/esm-form-engine-lib`. C'est utile lorsque vous avez besoin d'une gestion personnalis√©e de la soumission, souhaitez rendre les formulaires en dehors des espaces de travail, ou avez besoin d'un contr√¥le pr√©cis sur le comportement du formulaire.

### Utilisation de base

```tsx
import React from 'react';
import { FormEngine } from '@openmrs/esm-form-engine-lib';
import type { FormSchema } from '@openmrs/esm-form-engine-lib';

interface MyFormComponentProps {
  patientUuid: string;
  formSchema: FormSchema;
}

export function MyFormComponent({ patientUuid, formSchema }: MyFormComponentProps) {
  const handleSubmit = (encounters: Array<any>) => {
    console.log('Formulaire soumis :', encounters);
    // G√©rer la soumission du formulaire
  };

  return (
    <FormEngine
      patientUUID={patientUuid}
      formJson={formSchema}
      onSubmit={handleSubmit}
    />
  );
}
```

### Charger le sch√©ma de formulaire depuis l'UUID

Si vous avez un UUID de formulaire au lieu du sch√©ma, vous pouvez soit :

1. **Utiliser la prop form UUID** - Le FormEngine chargera automatiquement le sch√©ma :

```tsx
import React from 'react';
import { FormEngine } from '@openmrs/esm-form-engine-lib';

interface MyFormComponentProps {
  patientUuid: string;
  formUuid: string;
}

export function MyFormComponent({ patientUuid, formUuid }: MyFormComponentProps) {
  return (
    <FormEngine
      patientUUID={patientUuid}
      formUUID={formUuid}
    />
  );
}
```

2. **Charger le sch√©ma manuellement** - Si vous devez g√©rer vous-m√™me les √©tats de chargement ou les erreurs :

```tsx
import React from 'react';
import useSWR from 'swr';
import { FormEngine } from '@openmrs/esm-form-engine-lib';
import { openmrsFetch, restBaseUrl } from '@openmrs/esm-framework';
import type { FormSchema } from '@openmrs/esm-form-engine-lib';
import { InlineLoading } from '@carbon/react';

interface MyFormComponentProps {
  patientUuid: string;
  formUuid: string;
}

export function MyFormComponent({ patientUuid, formUuid }: MyFormComponentProps) {
  const { data, error, isLoading } = useSWR<{ data: FormSchema }>(
    `${restBaseUrl}/o3/forms/${formUuid}`,
    openmrsFetch
  );

  if (isLoading) {
    return <InlineLoading description="Chargement du formulaire..." />;
  }

  if (error || !data?.data) {
    return <div>Erreur lors du chargement du formulaire</div>;
  }

  const schema = { ...data.data, encounterType: data.data.encounterType['uuid'] };

  return (
    <FormEngine
      patientUUID={patientUuid}
      formJson={schema}
      formUUID={formUuid}
    />
  );
}
```

## Props et configuration du formulaire

Le composant `FormEngine` accepte les props suivantes :

### Props requises

- **`patientUUID`** (string) - L'UUID du patient pour lequel le formulaire est rempli

### Props optionnelles

- **`formUUID`** (string) - L'UUID du formulaire √† charger depuis le serveur. Si fourni, le sch√©ma du formulaire sera charg√© automatiquement. Si `formUUID` et `formJson` sont tous deux fournis, `formJson` prend la priorit√©.
- **`formJson`** (FormSchema) - L'objet sch√©ma de formulaire. Utilisez-le lorsque vous avez d√©j√† le sch√©ma charg√© ou souhaitez utiliser un sch√©ma personnalis√©.
- **`encounterUUID`** (string) - L'UUID d'une rencontre existante √† modifier. Lorsqu'il est fourni, le formulaire sera pr√©-rempli avec les donn√©es de la rencontre et rendu en mode √©dition.
- **`visit`** (Visit) - L'objet visite associ√© √† la session du formulaire. Si non fourni, le form engine utilisera la visite active du patient.
- **`mode`** (`'enter' | 'edit' | 'view' | 'embedded-view'`) - Le mode de rendu du formulaire. Voir [Modes de rendu des formulaires](#form-rendering-modes) ci-dessous.
- **`formSessionIntent`** (string) - L'intention de la session du formulaire (par d√©faut : `'*'`). Utilis√© pour filtrer les sessions de formulaire lors du chargement des valeurs initiales.
- **`onSubmit`** (function) - Fonction de rappel appel√©e lorsque le formulaire est soumis avec succ√®s. Re√ßoit un tableau des rencontres cr√©√©es/mises √† jour.
- **`onCancel`** (function) - Fonction de rappel appel√©e lorsque l'utilisateur annule le formulaire.
- **`handleClose`** (function) - Fonction de rappel appel√©e lorsque le formulaire doit √™tre ferm√©.
- **`handleConfirmQuestionDeletion`** (function) - Gestionnaire personnalis√© pour confirmer la suppression de questions r√©p√©tables. Doit retourner une Promise qui se r√©sout lorsque la suppression est confirm√©e.
- **`markFormAsDirty`** (function) - Fonction de rappel appel√©e lorsque l'√©tat "dirty" du formulaire change. Utile pour l'int√©gration dans les espaces de travail pour demander confirmation avant de fermer.
- **`hideControls`** (boolean) - Masquer les boutons d'action du formulaire (Enregistrer, Annuler). Utile pour les vues int√©gr√©es ou l'interface utilisateur personnalis√©e.
- **`hidePatientBanner`** (boolean) - Masquer la banni√®re patient qui appara√Æt dans les espaces de travail ultra-larges.
- **`preFilledQuestions`** (Record&lt;string, string&gt;) - Pr√©-remplir des questions sp√©cifiques avec des valeurs. Les cl√©s sont les IDs des questions, les valeurs sont les valeurs pr√©-remplies.

### Exemple avec toutes les props

```tsx
<FormEngine
  patientUUID="patient-uuid-here"
  formUUID="form-uuid-here"
  encounterUUID="encounter-uuid-here"
  mode="edit"
  formSessionIntent="*"
  onSubmit={(encounters) => {
    console.log('Formulaire soumis :', encounters);
  }}
  onCancel={() => {
    console.log('Formulaire annul√©');
  }}
  handleClose={() => {
    console.log('Formulaire ferm√©');
  }}
  markFormAsDirty={(isDirty) => {
    console.log('Formulaire modifi√© :', isDirty);
  }}
  hideControls={false}
  hidePatientBanner={false}
  preFilledQuestions={{
    'question-id-1': 'valeur-pr√©-remplie'
  }}
/>
```

## Modes de rendu des formulaires

Le React Form Engine prend en charge quatre modes de rendu, chacun adapt√© √† diff√©rents cas d'usage :

### Mode Enter (par d√©faut)

**Mode :** `'enter'` ou `undefined`

**Cas d'usage :** Cr√©er de nouvelles entr√©es de formulaire

**Comportement :**
- Le formulaire est rendu en mode lecture-√©criture
- Tous les champs sont modifiables
- Le formulaire peut √™tre soumis pour cr√©er une nouvelle rencontre
- S√©lectionn√© automatiquement lorsqu'aucun `encounterUUID` n'est fourni et que `mode` n'est pas sp√©cifi√©

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  mode="enter" // ou omettre pour la valeur par d√©faut
/>
```

### Mode Edit

**Mode :** `'edit'`

**Cas d'usage :** Modifier des entr√©es de formulaire existantes

**Comportement :**
- Le formulaire est rendu en mode lecture-√©criture
- Le formulaire est pr√©-rempli avec les donn√©es de la rencontre existante
- Le formulaire peut √™tre soumis pour mettre √† jour la rencontre
- S√©lectionn√© automatiquement lorsque `encounterUUID` est fourni et que `mode` n'est pas sp√©cifi√©

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  encounterUUID={encounterUuid}
  mode="edit" // ou omettre lorsque encounterUUID est fourni
/>
```

### Mode View

**Mode :** `'view'`

**Cas d'usage :** Afficher les donn√©es du formulaire en mode lecture seule

**Comportement :**
- Le formulaire est rendu en mode lecture seule
- Tous les champs sont d√©sactiv√©s
- Le formulaire ne peut pas √™tre soumis
- Les boutons d'action affichent "Fermer" au lieu de "Enregistrer"

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  encounterUUID={encounterUuid}
  mode="view"
/>
```

### Mode Embedded View

**Mode :** `'embedded-view'`

**Cas d'usage :** Afficher les donn√©es du formulaire dans un widget ou une carte condens√©e

**Comportement :**
- Le formulaire est rendu en mode lecture seule
- Les en-t√™tes de section et les actions du formulaire sont masqu√©s
- La banni√®re patient est masqu√©e
- La navigation lat√©rale est masqu√©e
- Mise en page compacte adapt√©e √† l'int√©gration dans d'autres composants

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  encounterUUID={encounterUuid}
  mode="embedded-view"
  hideControls={true}
/>
```

## Gestion de la soumission et de la r√©ponse du formulaire

Lorsqu'un formulaire est soumis, le callback `onSubmit` re√ßoit un tableau des rencontres qui ont √©t√© cr√©√©es ou mises √† jour. Chaque rencontre contient les donn√©es du formulaire qui ont √©t√© soumises.

### G√©rer la soumission du formulaire

```tsx
import { type Encounter } from '@openmrs/esm-framework';

function MyFormWorkspace({ patientUuid, formUuid }: Props) {
  const handleSubmit = (encounters: Array<Encounter>) => {
    const encounter = encounters[0];
    
    // G√©rer la soumission r√©ussie
    console.log('Rencontre cr√©√©e :', encounter.uuid);
    console.log('Observations :', encounter.obs);
    
    // Fermer l'espace de travail ou naviguer
    closeWorkspaceWithSavedChanges();
    
    // Actualiser les donn√©es li√©es
    mutate('/ws/rest/v1/encounter');
  };

  return (
    <FormEngine
      patientUUID={patientUuid}
      formUUID={formUuid}
      onSubmit={handleSubmit}
    />
  );
}
```

### Gestion des erreurs

Le Form Engine g√®re automatiquement les erreurs de validation et les affiche en ligne. Pour les erreurs de soumission, vous pouvez les g√©rer dans votre callback `onSubmit` ou utiliser l'√©tat d'erreur du formulaire :

```tsx
function MyFormWorkspace({ patientUuid, formUuid }: Props) {
  const [submitError, setSubmitError] = useState<Error | null>(null);

  const handleSubmit = async (encounters: Array<Encounter>) => {
    try {
      // La soumission du formulaire est g√©r√©e par le Form Engine
      // Ce callback est appel√© apr√®s une soumission r√©ussie
      console.log('Formulaire soumis avec succ√®s');
      closeWorkspaceWithSavedChanges();
    } catch (error) {
      setSubmitError(error);
    }
  };

  return (
    <>
      {submitError && (
        <InlineNotification
          kind="error"
          title="Erreur lors de la soumission du formulaire"
          subtitle={submitError.message}
        />
      )}
      <FormEngine
        patientUUID={patientUuid}
        formUUID={formUuid}
        onSubmit={handleSubmit}
      />
    </>
  );
}
```

## Exemple complet : Espace de travail de formulaire

Voici un exemple complet d'un espace de travail de formulaire qui s'int√®gre au dossier patient :

```tsx
import React, { useCallback, useMemo } from 'react';
import { ExtensionSlot } from '@openmrs/esm-framework';
import { type Encounter } from '@openmrs/esm-framework';
import { 
  type DefaultPatientWorkspaceProps 
} from '@openmrs/esm-patient-common-lib';

interface MyFormWorkspaceProps extends DefaultPatientWorkspaceProps {
  formUuid: string;
  encounterUuid?: string;
}

export function MyFormWorkspace({
  patientUuid,
  formUuid,
  encounterUuid,
  closeWorkspace,
  promptBeforeClosing,
  closeWorkspaceWithSavedChanges,
}: MyFormWorkspaceProps) {
  const handleSubmit = useCallback(
    (encounters: Array<Encounter>) => {
      console.log('Formulaire soumis :', encounters);
      closeWorkspaceWithSavedChanges();
      // Optionnellement actualiser les donn√©es li√©es ou afficher une notification de succ√®s
    },
    [closeWorkspaceWithSavedChanges]
  );

  const state = useMemo(
    () => ({
      view: 'form',
      formUuid,
      patientUuid,
      encounterUuid: encounterUuid ?? null,
      closeWorkspace,
      promptBeforeClosing,
      closeWorkspaceWithSavedChanges,
      additionalProps: {
        mode: encounterUuid ? 'edit' : 'enter',
        handlePostResponse: handleSubmit,
      },
    }),
    [
      formUuid,
      patientUuid,
      encounterUuid,
      closeWorkspace,
      promptBeforeClosing,
      closeWorkspaceWithSavedChanges,
      handleSubmit,
    ]
  );

  return <ExtensionSlot name="form-widget-slot" state={state} />;
}
```

## Pr√©-remplir les questions du formulaire

Vous pouvez pr√©-remplir des questions sp√©cifiques dans un formulaire en utilisant la prop `preFilledQuestions` :

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  preFilledQuestions={{
    'vitals-weight': '70',
    'vitals-height': '175',
    'chief-complaint': 'Le patient signale un mal de t√™te'
  }}
/>
```

Les cl√©s dans `preFilledQuestions` doivent correspondre √† la propri√©t√© `id` des questions dans votre sch√©ma de formulaire.

## Intention de session de formulaire

La prop `formSessionIntent` vous permet de filtrer les sessions de formulaire lors du chargement des valeurs initiales. C'est utile lorsque vous souhaitez pr√©-remplir un formulaire avec des donn√©es d'un type sp√©cifique de rencontre ou de session :

```tsx
<FormEngine
  patientUUID={patientUuid}
  formUUID={formUuid}
  formSessionIntent="VITALS" // Charger uniquement les valeurs des rencontres VITALS
/>
```

## Prochaines √©tapes

- D√©couvrez comment [cr√©er des formulaires avec le Form Builder](/docs/forms-in-o3/build-forms-with-o3-form-builder)
- Lisez la [documentation du React Form Engine](https://openmrs.atlassian.net/wiki/spaces/projects/pages/68747273/O3+Form+Docs) pour les fonctionnalit√©s avanc√©es
- Consultez la [documentation des espaces de travail](/docs/workspaces/creating-workspaces) pour en savoir plus sur la cr√©ation d'espaces de travail

